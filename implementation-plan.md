# 実装計画: ビットコイン・アービトラージ監視アプリ

## 1. 目的と前提
- 国内取引所（bitFlyer, Coincheck, bitbank）限定のアービトラージ監視要件を満たす実装ロードマップを定義する。
- 最初のプロダクションリリース（MVP）を8週間以内に行う想定で、継続的に拡張可能なアーキテクチャを用意する。

## 2. アーキテクチャ概要
- **データ収集サービス**: 各取引所のREST/WebSocketを利用し、ティッカーと浅いオーダーブックをPull/Streamする Go/Python サービス。Kafka などのメッセージバスへ配信。
- **正規化/ストレージ層**: 消費側でフォーマット統一、主要フィールドのみを Redis（リアルタイム）と TimescaleDB（履歴分析）へ書き込み。
- **スプレッド計算エンジン**: 抽象化した「取引所ペア」ごとにスプレッド・手数料計算を行う。閾値設定をRedis/DBからキャッシュし、1秒未満レイテンシで結果を生成。
- **アラートルーター**: 条件を満たしたイベントをメッセージキューへ投げ、メール/Slack/Webhookなどの送信ワーカーが処理。
- **設定/ダッシュボード**: Next.js + API Gateway (FastAPI/Express) 構成で設定管理、アラート履歴、監視情報を提供。
- **観測性**: OpenTelemetryでメトリクスとトレースをPrometheus/Grafanaに集約。アラート閾値はGrafana/Alertmanagerへ。

## 3. フェーズ分割
1. **フェーズ0: 基盤整備 (Week 1)**
   - IaCリポジトリ作成（Terraform or Pulumi）。
   - CI/CD（GitHub Actions）テンプレート、共通ライブラリ、Secrets管理を整備。
2. **フェーズ1: データ取得 & 正規化 (Week 2-3)**
   - 3取引所のPublic API クライアント実装。
   - WebSocket/RESTフォールバック。正規化スキーマとRedis／TimescaleDB連携。
   - 負荷テスト（サンプルデータで500ms間隔を再現）。
3. **フェーズ2: スプレッド計算と閾値管理 (Week 4-5)**
   - 計算エンジン、ペア設定、手数料テーブル、為替レート取得（必要なら）。
   - API/UIから閾値・数量をCRUDできるバックエンド実装。
4. **フェーズ3: 通知 & ダッシュボード (Week 6)**
   - Slack/メール/Webhook通知実装、クールダウン制御。
   - ダッシュボードにリアルタイムスプレッド、閾値設定UI、アラート履歴表示。
5. **フェーズ4: 観測性 & Hardening (Week 7)**
   - メトリクス・ログ・トレース導入。SLO/SLAモニタリング。
   - フェイルオーバーテスト、レートリミット異常時のリカバリ確認。
6. **フェーズ5: UAT / リリース (Week 8)**
   - ユーザー受け入れテスト、ドキュメント整備、運用Runbook作成。
   - 本番リリース、初期パフォーマンス監視。

## 4. 詳細タスク (抜粋)
- APIクライアント: 認証不要のPublic APIで開始、必要に応じPrivate API対応。
- 手数料/コスト計算: 取引所固有の手数料表を設定画面で管理できるようにし、資金移動手数料は静的設定から開始。
- ストレージ: Redis Cluster (リアルタイム)/TimescaleDB (履歴)。TimescaleDBは1日あたりのデータ量を試算しRetention Policyを設定。
- 通知テンプレート: Slack Block Kit、メールHTMLテンプレートを共通サービストークンで管理。
- RBAC/認証: MVPでは社内SSO(Okta/Google) + APIキー方式で実装。
- IaC/デプロイ: K8s上に各サービスをHelmチャートで展開。CIでテスト・lint→コンテナビルド→Helmリリース。
- テスト戦略: 単体テスト（APIクライアント、計算ロジック）、統合テスト（Mock取引所API）、E2Eテスト（UI+API）。

## 5. 依存関係とリスク
- 外部APIレート制限: バックオフ・マルチリージョンIPで耐性確保。
- データ精度: 取引所毎のタイムスタンプズレを調整、時刻同期（NTP）を徹底。
- 観測性に未整備の場合のMTTR増大: 早期にメトリクス収集を組み込む。
- チーム体制: バックエンド2名、フロント1名、SRE1名を最小構成と想定。

## 6. 成果物
- コードリポジトリ: /data-collector, /spread-engine, /api-gateway, /web-dashboard, /infra。
- ドキュメント: アーキテクチャ図、API仕様、運用Runbook、オンボーディングガイド。
- モニタリングダッシュボード: Grafana、アラートルール定義。

## 7. サクセスメトリクス
- Week 3 までに3取引所×500ms収集を安定稼働。
- Week 6 までに通知経路（Slack/メール/Webhook）で実環境テスト完了。
- リリース時点で KPI (アラート遅延<1秒, 誤検知率<2%) をモニタリングできる状態。
